import{observable,decorate,computed,autorun,action,toJS}from"../../../../mobx/lib/mobx.module.js";import{varExists,varGet}from"../../../utils/utils.js";import{JsonOutlineSchema}from"../../../json-outline-schema/json-outline-schema.js";class Store{constructor(){this.location=null,this.jwt=null,this.editMode=!1,this.manifest=null,this.activeItemContent="",this.themeElement=null,this.activeId=null,this.userData={},this.cmsSiteEditor={instance:null},this.cmsSiteEditorBackend={instance:null},this.dashboardOpened=!1}loadManifest(manifest,target=null){if(null==target&&window&&(target=window),varExists(manifest,"metadata.siteName")){let git=varGet(manifest,"publishing.git",{});manifest.metadata.site={name:manifest.metadata.siteName,git,created:manifest.metadata.created,updated:manifest.metadata.updated},manifest.metadata.theme.variables={image:manifest.metadata.image,icon:manifest.metadata.icon,hexCode:manifest.metadata.hexCode,cssVariable:manifest.metadata.cssVariable},manifest.metadata.node={dynamicElementLoader:manifest.metadata.dynamicElementLoader,fields:manifest.metadata.fields},delete manifest.metadata.publishing,delete manifest.metadata.created,delete manifest.metadata.updated,delete manifest.metadata.siteName,delete manifest.metadata.image,delete manifest.metadata.icon,delete manifest.metadata.hexCode,delete manifest.metadata.cssVariable,delete manifest.metadata.dynamicElementLoader,delete manifest.metadata.fields}manifest.items.forEach((item,index,array)=>{item.slug||(array[index].slug=item.location.replace("pages/","").replace("/index.html",""))});var site=new JsonOutlineSchema,nodes=site.itemsToNodes(manifest.items),correctOrder=site.nodesToItems(nodes),newItems=[];for(var key in correctOrder)newItems.push(manifest.items.find(element=>element.id===correctOrder[key].id));manifest.items=newItems,this.manifest=manifest,target.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:manifest}))}cmsSiteEditorAvailability(){return this.cmsSiteEditor.instance||(this.cmsSiteEditor.instance=document.createElement("haxcms-site-editor")),this.cmsSiteEditor.instance}get processedItems(){}_computeItems(start,end,parent,dynamicMethodology,_routerManifest){if(_routerManifest){let tmpItem,items=[],data=[];switch(_routerManifest.items.forEach(element=>{element.parent||items.push(element)}),dynamicMethodology){case"parent":tmpItem=_routerManifest.items.find(d=>parent===d.id),tmpItem&&(parent=tmpItem.parent);break;case"ancestor":for(tmpItem=_routerManifest.items.find(d=>parent===d.id);tmpItem&&null!=tmpItem.parent;)tmpItem=_routerManifest.items.find(i=>i.id==tmpItem.parent);tmpItem&&(parent=tmpItem.id)}return items.forEach((item,i)=>{this._spiderChildren(item,data,start,end,parent,!1)}),data}}_setChildren(item,data){const children=data.filter(d=>item.id===d.parent);item.children=children,item.children.length>0&&item.children.forEach(child=>{this._setChildren(child,data)})}get routerManifest(){const manifest=this.manifest;if(document.body.dispatchEvent(new CustomEvent("json-outline-schema-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:manifest})),manifest&&void 0!==manifest.items){let userData=JSON.parse(window.localStorage.getItem("HAXCMSSystemData"));var accessData={};null==userData&&(userData={manifests:{}},userData.manifests[manifest.id]={accessData:{}},window.localStorage.setItem("HAXCMSSystemData",JSON.stringify(userData))),userData&&void 0!==userData.manifests&&void 0!==userData.manifests[manifest.id]&&"undefined"!==userData.manifests[manifest.id].accessData&&(accessData=userData.manifests[manifest.id].accessData);let manifestItems=manifest.items.map(i=>{let parentLocation=null,parentSlug=null,parent=manifest.items.find(d=>i.parent===d.id);parent&&(parentLocation=parent.location,parentSlug=parent.slug);let metadata=i.metadata;void 0!==accessData[i.id]&&(metadata.accessData=accessData[i.id]);let location=i.location,slug=i.slug;return Object.assign({},i,{parentLocation,parentSlug,location,slug,metadata})});if(manifestItems.forEach((item,i)=>{this._setChildren(item,manifestItems)}),!0===varGet(manifest,"metadata.site.settings.publishPagesOn",!1)){const filterHiddenParentsRecursive=item=>{if(!1===item.metadata.published)return!1;const parent=manifestItems.find(i=>i.id===item.parent);return!parent||filterHiddenParentsRecursive(parent)};manifestItems=manifestItems.filter(i=>filterHiddenParentsRecursive(i))}return Object.assign({},manifest,{items:manifestItems,accessData})}}get siteTitle(){const manifest=this.manifest;return manifest&&manifest.title?manifest.title:""}get homeLink(){if(this.manifest){const firstItem=this.manifest.items.find(i=>void 0!==i.id);if(firstItem)return firstItem.slug}return"/"}get activeItem(){let item=this.findItem(this.activeId);return item||null}get activeItemFields(){if(this.activeItem&&this.activeItem.metadata){let fields={title:this.activeItem.title,description:this.activeItem.description,location:this.activeItem.location,slug:this.activeItem.slug,created:this.activeItem.metadata.created,updated:this.activeItem.metadata.created};if(this.activeItem.metadata.fields)return Object.assign({},fields,this.activeItem.metadata.fields)}}get themeData(){if(this.manifest){var themeData={};return themeData=varExists(this.manifest,"metadata.theme")?this.manifest.metadata.theme:{"haxcms-basic-theme":{element:"haxcms-basic-theme",path:"@lrnwebcomponents/haxcms-elements/lib/core/themes/haxcms-basic-theme.js",name:"Basic theme",variables:{image:"assets/banner.jpg",icon:"icons:record-voice-over",hexCode:"#da004e",cssVariable:"pink"}}},this.activeItem&&varExists(this.activeItem,"metadata.theme")?this.activeItem.metadata.theme:themeData}}get activeManifestIndex(){if(this.manifest&&this.manifest.items&&this.activeId)for(var index in this.manifest.items)if(this.manifest.items[index].id===this.activeId)return parseInt(index);return-1}get activeRouterManifestIndex(){if(this.routerManifest&&this.routerManifest.items&&this.activeId)for(var index in this.routerManifest.items)if(this.routerManifest.items[index].id===this.activeId)return parseInt(index);return-1}get activeManifestIndexCounter(){return null!==this.activeManifestIndex?1+this.activeManifestIndex:0}get activeTitle(){return this.activeItem?this.activeItem.title:""}get parentTitle(){if(this.manifest&&this.activeItem){let tmpItem=this.manifest.items.find(d=>this.activeItem.parent===d.id);if(tmpItem)return tmpItem.title}return""}get isLoggedIn(){return!(!this.jwt||"null"==this.jwt)}get ancestorTitle(){if(this.manifest&&this.activeItem){let tmpItem=this.manifest.items.find(d=>this.activeItem.parent===d.id);for(;tmpItem&&null!=tmpItem.parent;)tmpItem=this.manifest.items.find(i=>i.id==tmpItem.parent);if(tmpItem)return tmpItem.title}return""}findItem(id){return this.manifest&&id?this.manifest.items.find(item=>item.id===id):null}spiderChildren(item,data,start,end,parent,parentFound,noDynamicLevel){item.id===parent||parentFound?(parentFound||(parentFound=!0,!noDynamicLevel&&item.indent>=start&&(start+=item.indent,end+=item.indent)),item.indent>=start&&item.indent<=end&&data.push(item),item.children.length>0&&item.children.forEach(child=>{this.spiderChildren(child,data,start,end,parent,parentFound,noDynamicLevel)})):item.children.length>0&&item.children.forEach(child=>{this.spiderChildren(child,data,start,end,parent,parentFound,noDynamicLevel)})}computeItems(start,end,parent,dynamicMethodology,_routerManifest,noDynamicLevel){if(_routerManifest){let tmpItem,items=[],data=[];switch(_routerManifest.items.forEach(element=>{element.parent||items.push(element)}),dynamicMethodology){case"parent":tmpItem=_routerManifest.items.find(d=>parent===d.id),tmpItem&&(parent=tmpItem.parent);break;case"ancestor":for(tmpItem=_routerManifest.items.find(d=>parent===d.id);tmpItem&&null!=tmpItem.parent;)tmpItem=_routerManifest.items.find(i=>i.id==tmpItem.parent);tmpItem&&(parent=tmpItem.id)}return _routerManifest.items.forEach((item,i)=>{store.spiderChildren(item,data,start,end,parent,!1,noDynamicLevel)}),data}}}decorate(Store,{location:observable.ref,editMode:observable,jwt:observable,dashboardOpened:observable,userData:observable,manifest:observable,activeItemContent:observable,themeElement:observable,routerManifest:computed,siteTitle:computed,isLoggedIn:computed,themeData:computed,homeLink:computed,activeId:observable,activeItem:computed,activeItemFields:computed,activeManifestIndex:computed,activeManifestIndexCounter:computed,activeTitle:computed,parentTitle:computed,ancestorTitle:computed,changeActiveItem:action.bound});export const store=new Store;window.HAXCMS=window.HAXCMS||{},window.HAXCMS.requestAvailability=()=>(window.HAXCMS.instance||(window.HAXCMS.instance=document.createElement("haxcms-site-store"),document.body.appendChild(window.HAXCMS.instance)),window.HAXCMS.instance),window.HAXCMS.requestAvailability();class HAXCMSSiteStore extends HTMLElement{constructor(){super(),this.store=store,this.source="",autorun(()=>{if(store.location&&store.location.route&&store.location.route.component){const id=store.location.route.name;store.manifest.items.filter(item=>item.id===id)&&(store.activeId=id)}}),autorun(()=>{const foundItem=toJS(store.findItem(store.activeId));foundItem&&document.body.dispatchEvent(new CustomEvent("json-outline-schema-active-item-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:foundItem}))}),autorun(()=>{const editMode=toJS(store.editMode);window.HaxStore&&window.HaxStore.write&&(window.dispatchEvent(new CustomEvent("haxcms-edit-mode-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:editMode})),window.HaxStore.write("editMode",editMode,window.HaxStore.instance),window.HaxStore.instance&&window.HaxStore.instance.globalPreferences.haxVoiceCommands&&setTimeout(()=>{window.HaxStore.instance.__hal.auto=!0},10))})}static get tag(){return"haxcms-site-store"}static get observedAttributes(){return["source"]}set source(value){this[name]=value,value&&this.setAttribute("source",value)}get source(){return this.getAttribute("source")}attributeChangedCallback(name,oldVal,newVal){"source"==name&&""!=newVal&&fetch(this[name]).then(response=>response.json()).then(data=>{this.store.loadManifest(data)}).catch(err=>{console.warn(err)})}}window.customElements.define(HAXCMSSiteStore.tag,HAXCMSSiteStore);export{HAXCMSSiteStore};