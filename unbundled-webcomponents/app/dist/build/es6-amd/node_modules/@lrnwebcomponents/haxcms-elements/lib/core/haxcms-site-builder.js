define(["exports","meta","require","../../../../lit-element/lit-element.js","../../../../@polymer/polymer/lib/utils/settings.js","../../../utils/utils.js","../../../../mobx/lib/mobx.module.js","./haxcms-site-store.js"],(function(_exports,meta,_require,_litElement,_settings,_utils,_mobxModule,_haxcmsSiteStore){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.HAXCMSSiteBuilder=void 0,meta=babelHelpers.interopRequireWildcard(meta),_require=babelHelpers.interopRequireWildcard(_require);class HAXCMSSiteBuilder extends _litElement.LitElement{static get styles(){return[_litElement.css`
        :host {
          display: block;
        }
        :host #slot {
          background-color: var(--haxcms-color, white);
          opacity: 0.2;
          visibility: hidden;
        }
        :host([dashboard-opened]) {
          display: inline-block !important;
          margin-left: 50vw;
          height: 100vh;
          pointer-events: none;
          opacity: 0.5;
          width: 100vw;
        }
        :host([theme-loaded]) #slot {
          opacity: 1;
          visibility: visible;
        }
        paper-progress {
          display: block;
          width: 100%;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background-color: transparent;
          z-index: 1000;
          --paper-progress-active-color: var(
            --haxcms-color,
            rgba(255, 255, 255, 0.5)
          );
          --paper-progress-container-color: transparent;
        }
      `]}static get tag(){return"haxcms-site-builder"}render(){return _litElement.html`
      <haxcms-site-router base-uri="${this.baseURI}"></haxcms-site-router>
      <paper-progress .hidden="${!this.loading}" indeterminate></paper-progress>
      <div id="slot"><slot></slot></div>
      <simple-colors-polymer></simple-colors-polymer>
    `}_updateManifest(data){this.manifest={...data}}_updateLoading(e){this.loading=e.detail.value}_updateActiveItemContent(data){this.activeItemContent=data}firstUpdated(){this.loadJOSData()}async loadPageData(){this.activeItemLocation&&(this.loading=!0,await fetch(`${this.outlineLocation}${this.activeItemLocation}${this._timeStamp}`).then(response=>response.text()).then(data=>{this._updateActiveItemContent(data),this.loading=!1}).catch(err=>{this.lastErrorChanged(err)}))}async loadJOSData(){this.file&&(this.loading=!0,await fetch(`${this.outlineLocation}${this.file}${this._timeStamp}`).then(response=>response.json()).then(data=>{this._updateManifest(data),this.loading=!1}).catch(err=>{this.lastErrorChanged(err)}))}updated(changedProperties){changedProperties.forEach((oldValue,propName)=>{["outlineLocation","activeItemLocation","_timeStamp"].includes(propName)&&this.loadPageData(),["outlineLocation","file","_timeStamp"].includes(propName)&&this.loadJOSData(),"dashboardOpened"==propName?this._dashboardOpenedChanged(this[propName],oldValue):"themeData"==propName?this._themeChanged(this[propName],oldValue):"themeName"==propName?this._themeNameChanged(this[propName],oldValue):"outlineLocation"==propName?this.dispatchEvent(new CustomEvent("outline-location-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[propName]})):"manifest"==propName?(this.dispatchEvent(new CustomEvent("manifest-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[propName]})),this._manifestChanged(this[propName],oldValue)):"activeItem"==propName?(this.dispatchEvent(new CustomEvent("active-item-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[propName]})),this._activeItemChanged(this[propName],oldValue)):"activeItemContent"==propName&&(this.dispatchEvent(new CustomEvent("active-item-content-changed",{bubbles:!0,cancelable:!0,composed:!0,detail:this[propName]})),this._activeItemContentChanged(this[propName],oldValue))})}static get properties(){return{activeItemLocation:{type:String,attribute:"active-item-location"},_timeStamp:{type:String},dashboardOpened:{type:Boolean,reflect:!0,attribute:"dashboard-opened"},queryParams:{type:Object},loading:{type:Boolean,reflect:!0},outlineLocation:{type:String,attribute:"outline-location"},manifest:{type:Object},themeData:{type:Object},themeName:{type:String},__imported:{type:Object},themeLoaded:{type:Boolean,reflect:!0,attribute:"theme-loaded"},activeItem:{type:Object},activeItemContent:{type:String},file:{type:String},baseURI:{type:String,attribute:"base-uri"}}}_themeNameChanged(newValue){newValue&&(_haxcmsSiteStore.store.themeElement&&_haxcmsSiteStore.store.themeElement.remove(),(0,_utils.wipeSlot)(this,"*"),_haxcmsSiteStore.store.themeElement=document.createElement(newValue),this.appendChild(_haxcmsSiteStore.store.themeElement))}lastErrorChanged(e){if(e){console.error(e);const evt=new CustomEvent("simple-toast-show",{bubbles:!0,composed:!0,cancelable:!1,detail:{text:e.detail.value.status+" "+e.detail.value.statusText}});window.dispatchEvent(evt)}}constructor(){super(),(0,_settings.setPassiveTouchGestures)(!0),this.__disposer=[],this.queryParams={},this.loading=!1,this.__imported={},this.themeLoaded=!1,this._timeStamp="",this.outlineLocation="",this.activeItemLocation="",new Promise((res,rej)=>_require.default(["./haxcms-site-router.js"],res,rej)),new Promise((res,rej)=>_require.default(["../../../../@polymer/paper-progress/paper-progress.js"],res,rej)),new Promise((res,rej)=>_require.default(["../../../simple-toast/simple-toast.js"],res,rej)),new Promise((res,rej)=>_require.default(["../../../simple-colors/lib/simple-colors-polymer.js"],res,rej)),setTimeout(()=>{window.addEventListener("hax-store-ready",this.storeReady.bind(this)),window.addEventListener("haxcms-trigger-update",this._triggerUpdatedData.bind(this)),window.addEventListener("haxcms-trigger-update-node",this._triggerUpdatedNode.bind(this)),(0,_mobxModule.autorun)(reaction=>{this.dashboardOpened=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.dashboardOpened),this.__disposer.push(reaction)}),(0,_mobxModule.autorun)(reaction=>{this.themeData=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.themeData),this.themeData&&this.themeData.element!==this.themeName&&(this.themeName=this.themeData.element),this.__disposer.push(reaction)}),(0,_mobxModule.autorun)(reaction=>{this.activeItem=(0,_mobxModule.toJS)(_haxcmsSiteStore.store.activeItem),this.activeItem&&this.activeItem.location&&(this.activeItemLocation=this.activeItem.location),this.__disposer.push(reaction)})},0)}_dashboardOpenedChanged(newValue,oldValue){newValue?(this.setAttribute("aria-hidden","aria-hidden"),this.setAttribute("tabindex","-1")):!newValue&&oldValue&&(this.removeAttribute("aria-hidden"),this.removeAttribute("tabindex"))}connectedCallback(){super.connectedCallback(),this.dispatchEvent(new CustomEvent("haxcms-ready",{bubbles:!0,composed:!0,cancelable:!1,detail:this})),new Promise((res,rej)=>_require.default(["./haxcms-editor-builder.js"],res,rej)).then(response=>{this.editorBuilder=document.createElement("haxcms-editor-builder"),document.body.appendChild(this.editorBuilder),"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3))}).catch(error=>{console.log(error)});var evt=document.createEvent("UIEvents");evt.initUIEvent("resize",!0,!1,window,0),window.dispatchEvent(evt)}disconnectedCallback(){for(var i in this.__disposer)this.__disposer[i].dispose();super.disconnectedCallback()}storeReady(e){_haxcmsSiteStore.store.cmsSiteEditor&&_haxcmsSiteStore.store.cmsSiteEditor.instance&&window.HaxStore.instance.activeHaxBody&&_haxcmsSiteStore.store.activeItemContent&&window.HaxStore.instance.activeHaxBody.importContent(_haxcmsSiteStore.store.activeItemContent)}_activeItemContentChanged(newValue,oldValue){if(newValue){var html=newValue;null!==html&&((0,_utils.wipeSlot)(_haxcmsSiteStore.store.themeElement,"*"),html=(0,_utils.encapScript)(newValue),_haxcmsSiteStore.store.activeItemContent=html,setTimeout(()=>{if(0===_haxcmsSiteStore.store.themeElement.childNodes.length){let frag=document.createRange().createContextualFragment(html);_haxcmsSiteStore.store.themeElement.appendChild(frag),this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:html}))}if(!window.WCAutoload&&(0,_utils.varExists)(this.manifest,"metadata.node.dynamicElementLoader")){let tagsFound=(0,_utils.findTagsInHTML)(html);const basePath=this.pathFromUrl(decodeURIComponent(meta.url));for(var i in tagsFound){const tagName=tagsFound[i];this.manifest.metadata.node.dynamicElementLoader[tagName]&&!window.customElements.get(tagName)&&new Promise((res,rej)=>_require.default([`${basePath}../../../../${this.manifest.metadata.node.dynamicElementLoader[tagName]}`],res,rej)).then(response=>{}).catch(error=>{console.log(error)})}}else window.WCAutoload&&setTimeout(()=>{window.WCAutoload.process()},0)},5))}}_activeItemChanged(newValue,oldValue){this.shadowRoot&&newValue&&void 0!==newValue.id?(this.queryParams.nodeId=newValue.id,this.editorBuilder&&"published"===this.editorBuilder.getContext()?this._timeStamp="":this._timeStamp="?"+Math.floor(Date.now()/1e3)):oldValue&&!newValue&&this.dispatchEvent(new CustomEvent("json-outline-schema-active-body-changed",{bubbles:!0,composed:!0,cancelable:!1,detail:null}))}_triggerUpdatedData(e){this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3))}_triggerUpdatedNode(e){this.editorBuilder&&"published"!==this.editorBuilder.getContext()&&"demo"!==this.editorBuilder.getContext()&&(this._timeStamp="?"+Math.floor(Date.now()/1e3)),this.activeItem.location&&this.loadPageData()}_manifestChanged(newValue,oldValue){newValue&&newValue.metadata&&newValue.items&&_haxcmsSiteStore.store.loadManifest(newValue,this)}pathFromUrl(url){return url.substring(0,url.lastIndexOf("/")+1)}_themeChanged(newValue,oldValue){if(newValue){this.themeLoaded=!1;let theme=newValue;if(void 0!==this.__imported[theme.element])this.themeLoaded=!0;else if(window.WCAutoload)this.__imported[theme.element]=theme.element,this.themeLoaded=!0,setTimeout(()=>{window.WCAutoload.process()},5);else try{new Promise((res,rej)=>_require.default([this.pathFromUrl(decodeURIComponent(meta.url))+"../../../../"+newValue.path],res,rej)).then(e=>{this.__imported[theme.element]=theme.element,this.themeLoaded=!0})}catch(err){this.themeLoaded=!0}}}}_exports.HAXCMSSiteBuilder=HAXCMSSiteBuilder,window.HAXme=function(context=null){null==context&&(context="demo",window.appSettings={login:"dist/dev/login.json",logout:"dist/dev/logout.json",saveNodePath:"dist/dev/saveNode.json",saveManifestPath:"dist/dev/saveManifestPath.json",createNodePath:"dist/dev/saveNode.json",deleteNodePath:"dist/dev/saveNode.json",saveOutlinePath:"dist/dev/saveNode.json",publishSitePath:"dist/dev/saveNode.json",syncSitePath:"dist/dev/saveNode.json",getNodeFieldsPath:"dist/dev/getNodeFieldsPath.json",getSiteFieldsPath:"dist/dev/getSiteFieldsPath.json",revertSitePath:"dist/dev/saveNode.json",getFormToken:"adskjadshjudfu823u823u8fu8fij",appStore:{url:"dist/dev/appstore.json"},themes:{"haxcms-dev-theme":{element:"haxcms-dev-theme",path:"@lrnwebcomponents/haxcms-elements/lib/haxcms-dev-theme.js",name:"Developer theme"}}}),"demo"==context&&(window.__haxCMSContextDemo=!0),document.body&&(document.body.getElementsByTagName("haxcms-editor-builder")[0].__appliedContext=!1,document.body.getElementsByTagName("haxcms-editor-builder")[0].applyContext(context))},window.customElements.define(HAXCMSSiteBuilder.tag,HAXCMSSiteBuilder)}));